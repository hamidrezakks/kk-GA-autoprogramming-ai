<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>KK GA Self Programming</title>
<script type="text/ecmascript" src="jquery-2.1.3.min.js" ></script>
<link rel="stylesheet" href="css.css" />
</head>

<body>
	<div id="pop-up">
    	<input type="text" id="target" placeholder="TARGET!" value="My name is HamidrezaKK!" />
        <input type="text" id="gen-pop" placeholder="Population count" value="20" />
        <input type="button" id="btn" value="RUN" />
        <div id="warning" ></div>
    </div>
    <div id="main">
    </div>
    <div id="temp" style="display: none;">
    </div>
</body>
<script>
	/* copyright hamidrezakk 2015 */
	var target;
	var cNum;
	var cWidth;
	var mainInterval;
	
	var state = "genPop";
	var gens = Array();
	var numPop = 20;
	var storeCnt = 0;
	
	var best , bestScore, runnerUp , runnerUpScore;
	var generations = 0;
	
	$("#btn").click(function(){
		target = $("#target").val();
		numPop = parseInt($("#gen-pop").val());
		if(target.length < 3)
		{
			$("#warning").html("Min char is 3!");
		}
		else
		{
			$("#warning").html("");
			iniLayout();
			$("#pop-up").fadeOut(300);
			
		}
	});
	function iniLayout()
	{
		var myMain = $("#main");
		myMain.empty().append('<div id="gens"></div><div id="list"></div>');
		var wHeight = $(document).height() - 20;
		myMain.css({'height':wHeight+'px'});
		cNum = target.length + 5;
		
		target = '|*"'+target+'";';
		
		cWidth = 1000/cNum;
		for(i = 0; i < cNum; i++)
		{
			tempC = target.charAt(i);
			temp = '<div class="col _n'+i+'" style="width:'+(cWidth-2)+'px;left:'+(cWidth*i)+'px" ></div>';
			myMain.append(temp);
		}
		/*setInterval(function(){
			rand = Math.floor(Math.random()*cNum);
			insertCell(getRandChar(),rand);
		},1);*/
		mainInterval = setInterval(function(){
			runGA();
		},15);
	}
	function charMaps(stri)
	{
		var string = '';
		for(j = 0; j < stri.length ; j++)
		{
			string += charMap(stri.charAt(j));
		}
		return string;
	}
	function showGenList(oid)
	{
		id = oid.attr("oid");
		$("#list").empty().stop().fadeIn(100,function(){
			var child = $("#temp > ._x"+id).children();
			for(i = 0; i < child.length; i++)
			{
				$("#list").append((i+1)+") "+charMaps(child.eq(i).text())+"<br>");
			}
			console.log(id);
		});
	}
	
	function insertCell(char, colNum, ok)
	{
		col = $("#main > .col._n"+colNum);
		padding = (cWidth-17)/2;
		col.prepend('<div oid="'+storeCnt+'" class="cell gen_'+storeCnt+' '+((ok == 1)? 'ok' : '')+'" style="width:'+(cWidth-2)+'px;padding:'+padding+'px 0;" >'+char+'</div>');
		$(".gen_"+storeCnt).mouseenter(function(){
			showGenList($(this));
		}).mouseleave(function(){
			$("#list").stop().fadeOut(100);
		});
	}
	
	function getRandChar() 
	{
		var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghjiklmnopqrstuvwxyz,! |*;"#@+';
		// | -> cout
		// * -> <<
		return letters.charAt(Math.floor((Math.random()*letters.length)));
	}
	
	function scoreCheck(x, y) {
		var count = 0;
		for (var i = 0; i < cNum; i++) {
			count -= Math.abs(x.charCodeAt(i)-y.charCodeAt(i)); // minus point for wrong math - closer characters get less negative points
			if (x.substring(i, i+1) == y.substring(i, i+1)) 
				count += 100; //100poiny for match character
		}
		return count;
	}
	/*var states = [genPop, checkScore, swap, mutation, remix, final];*/
	
	function storeGens()
	{
		var temp = $("#temp");
		var str = '<div class="_x'+storeCnt+'">';
		for(i = 0; i < numPop; i++)
		{
			str += '<div class="_y'+i+'">';
			str += gens[i];
			str += '</div>';
		}
		str += '</div>';
		temp.append(str);
		storeCnt++;
	}
	function runGA()
	{
		switch(state)
		{
			case "genPop":
				for (i = 0; i < numPop; i++) 
				{
					var str = '';
					for (j = 0; j < cNum; j++)
						str += getRandChar();	
					gens.push(str);
					
				}
				storeGens();
				best = runnerUp = gens[0];
				state = "remix";
			break;
			case "remix":
				for (i = 0; i < numPop; i++) 
				{
					if(Math.random() > 0.6)
					{
						temp = best;
						best = runnerUp;
						runnerUp = temp;
					}
					//randomly remix top 2 children
					mixAt = Math.floor(Math.random()*cNum);
					//new population will be generated by top two parents
					gens[i] = best.substring(0, mixAt)+runnerUp.substring(mixAt, cNum);
					
					//mutation
					if (Math.random() < 0.5) 
					{
						mutateAt = Math.floor(Math.random()*cNum) + 1;
						gens[i] = gens[i].substring(0, mutateAt - 1)+getRandChar()+gens[i].substring(mutateAt, cNum);
					}
				}
				generations += numPop;
				storeGens();
				state = "score";
			break;
			case "score":
				best = gens[0];
				runnerUp = gens[1];
				bestScore = -cNum*1000;
				runnerUpScore = -cNum*1000;
				
				tempId = 0;
				
				//QT
				for (i = 0; i < numPop; i++) 
				{
					var score = scoreCheck(gens[i], target);
					if (score > bestScore) 
					{
						best = gens[i];
						bestScore = score;
						tempId = i;
						if (best == target) 
						{
							state = "final";
							generations += (numPop - i);
							return;
						}
					} 
				}
				
				gens[tempId] = "123";
				
				for (i = 0; i < numPop; i++) 
				{
					var score = scoreCheck(gens[i], target);
					if (score > runnerUpScore) 
					{
						runnerUp = gens[i];
						runnerUpScore = score;
						if (best == target) 
						{
							state = "final";
							generations += (numPop - i);
							return;
						}
					} 
				}
				
				if(generations > 100000)
				{
					state = "final";
					generations += (numPop - i);
					return;
				}
				
				gens[tempId] = best;
				showResult();
				$("#gens").html("Gens:"+generations);
				state = "remix";
			break;
			case "final":
				clearInterval(mainInterval);
				showResult();
				$("#gens").html("Gens:"+generations);
				storeGens();
			break;
		}
	}
	
	var lastGen = '';
	function charMap(char)
	{
		if(char == "|")
			return "cout";
		else if(char == "*")
			return "&lt;&lt;";
		else if(char == "#")
			return "cin";
		else if(char == "@")
			return "&gt;&gt;";
		else 
			return char;
		
	}
	function showResult()
	{
		for(i = 0; i < cNum; i++)
		{
			if(lastGen.charAt(i) != best.charAt(i))
				insertCell(charMap(best.charAt(i)),i,(target.charAt(i) == best.charAt(i))? 1 : 0);
		}
		lastGen = best;
	}
	
	
	
</script>
</html>
